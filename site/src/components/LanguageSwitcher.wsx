/** @jsxImportSource @wsxjs/wsx-core */
/**
 * LanguageSwitcher Component
 * ËØ≠Ë®ÄÂàáÊç¢Âô®ÁªÑ‰ª∂ÔºåÁî®‰∫éÂàáÊç¢ i18next ÁöÑËØ≠Ë®Ä
 * ‰∏ç‰ΩøÁî®ÂõΩÊóóÂõæÊ†áÔºå‰ΩøÁî®ËØ≠Ë®ÄÂêçÁß∞ÊòæÁ§∫
 *
 * ËøôÊòØ‰∏Ä‰∏™Á§∫‰æãÁªÑ‰ª∂ÔºåÂ±ïÁ§∫Â¶Ç‰ΩïÂú® WSXJS ‰∏≠‰ΩøÁî® i18next
 * ÂèÇËÄÉ RFC-0029: i18next ÂõΩÈôÖÂåñÊîØÊåÅ
 */
import { WebComponent, autoRegister, state } from "@wsxjs/wsx-core";
import { i18nInstance } from "@wsxjs/wsx-i18next";
import styles from "./LanguageSwitcher.css?inline";

/**
 * ËØ≠Ë®ÄÈÄâÈ°πÊé•Âè£
 */
export interface LanguageOption {
    /** ËØ≠Ë®Ä‰ª£Á†ÅÔºàÂ¶Ç 'en', 'zh'Ôºâ */
    code: string;
    /** ËØ≠Ë®ÄÊòæÁ§∫ÂêçÁß∞ÔºàÂ¶Ç 'English', '‰∏≠Êñá'Ôºâ */
    name: string;
}

@autoRegister({ tagName: "language-switcher" })
export default class LanguageSwitcher extends WebComponent {
    /** ÊîØÊåÅÁöÑËØ≠Ë®ÄÂàóË°® */
    private languages: LanguageOption[] = [
        { code: "en", name: "English" },
        { code: "zh", name: "‰∏≠Êñá" },
        { code: "es", name: "Espa√±ol" },
        { code: "fr", name: "Fran√ßais" },
        { code: "de", name: "Deutsch" },
        { code: "ja", name: "Êó•Êú¨Ë™û" },
        { code: "ko", name: "ÌïúÍµ≠Ïñ¥" },
    ];

    /** ÂΩìÂâçÈÄâ‰∏≠ÁöÑËØ≠Ë®Ä‰ª£Á†Å */
    @state private currentLanguage: string = "en";

    /** ‰∏ãÊãâËèúÂçïÊòØÂê¶ÊâìÂºÄ */
    @state private isOpen: boolean = false;

    /** ‰∏ãÊãâËèúÂçïÂÖÉÁ¥†ÂºïÁî® */
    private dropdownElement?: HTMLElement;
    private buttonElement?: HTMLElement;

    constructor() {
        super({
            styles,
            styleName: "language-switcher",
        });
    }

    render(): HTMLElement {
        const currentLang = this.languages.find((lang) => lang.code === this.currentLanguage);
        const displayName = currentLang?.name || this.currentLanguage.toUpperCase();

        return (
            <div class="language-switcher-container">
                <button
                    ref={(el) => (this.buttonElement = el)}
                    class="language-switcher-btn"
                    onClick={this.toggleDropdown}
                    aria-label={`Current language: ${displayName}`}
                    aria-expanded={this.isOpen}
                    aria-haspopup="listbox"
                >
                    <span class="language-switcher-icon">üåê</span>
                    <span class="language-switcher-text">{displayName}</span>
                    <span class="language-switcher-arrow">{this.isOpen ? "‚ñ≤" : "‚ñº"}</span>
                </button>

                {this.isOpen && (
                    <div
                        ref={(el) => (this.dropdownElement = el)}
                        class="language-switcher-dropdown"
                        role="listbox"
                    >
                        {this.languages.map((lang) => (
                            <button
                                key={lang.code}
                                class={`language-switcher-option ${
                                    lang.code === this.currentLanguage ? "active" : ""
                                }`}
                                onClick={() => this.selectLanguage(lang.code)}
                                role="option"
                                aria-selected={lang.code === this.currentLanguage}
                            >
                                <span class="language-name">{lang.name}</span>
                                <span class="language-code">{lang.code.toUpperCase()}</span>
                            </button>
                        ))}
                    </div>
                )}
            </div>
        );
    }

    /**
     * ÂàáÊç¢‰∏ãÊãâËèúÂçï
     */
    private toggleDropdown = (): void => {
        this.isOpen = !this.isOpen;
        this.rerender();

        if (this.isOpen) {
            // ÁÇπÂáªÂ§ñÈÉ®ÂÖ≥Èó≠‰∏ãÊãâËèúÂçï
            setTimeout(() => {
                document.addEventListener("click", this.handleOutsideClick, true);
            }, 0);
        } else {
            document.removeEventListener("click", this.handleOutsideClick, true);
        }
    };

    /**
     * Â§ÑÁêÜÁÇπÂáªÂ§ñÈÉ®Âå∫Âüü
     */
    private handleOutsideClick = (event: Event): void => {
        const target = event.target as Node;
        if (
            this.dropdownElement &&
            this.buttonElement &&
            !this.dropdownElement.contains(target) &&
            !this.buttonElement.contains(target)
        ) {
            this.isOpen = false;
            this.rerender();
            document.removeEventListener("click", this.handleOutsideClick, true);
        }
    };

    /**
     * ÈÄâÊã©ËØ≠Ë®Ä
     */
    private selectLanguage = (languageCode: string): void => {
        if (languageCode === this.currentLanguage) {
            this.isOpen = false;
            this.rerender();
            return;
        }

        // Êõ¥Êîπ i18next ËØ≠Ë®Ä
        i18nInstance.changeLanguage(languageCode).then(() => {
            this.currentLanguage = languageCode;
            this.isOpen = false;
            this.rerender();

            // ‰øùÂ≠òÂà∞ localStorage
            localStorage.setItem("wsx-language", languageCode);
        });
    };

    /**
     * ÁªÑ‰ª∂ËøûÊé•Êó∂ÂàùÂßãÂåñ
     */
    protected onConnected(): void {
        // ‰ªé localStorage Êàñ i18next Ëé∑ÂèñÂΩìÂâçËØ≠Ë®Ä
        const savedLanguage = localStorage.getItem("wsx-language");
        const fallbackLng = i18nInstance.options.fallbackLng;
        const fallbackLngStr =
            typeof fallbackLng === "string"
                ? fallbackLng
                : Array.isArray(fallbackLng)
                  ? fallbackLng[0]
                  : "en";
        const i18nLanguage = i18nInstance.language || fallbackLngStr;

        // Ëé∑ÂèñÂü∫Á°ÄËØ≠Ë®Ä‰ª£Á†ÅÔºàÂ§ÑÁêÜ 'en-US' -> 'en' ÁöÑÊÉÖÂÜµÔºâ
        const baseLanguage = (savedLanguage || i18nLanguage).split("-")[0];

        if (baseLanguage !== this.currentLanguage) {
            this.currentLanguage = baseLanguage;
            // Â¶ÇÊûú localStorage ‰∏≠ÁöÑËØ≠Ë®Ä‰∏é i18next ‰∏ç‰∏ÄËá¥ÔºåÊõ¥Êñ∞ i18next
            if (savedLanguage && savedLanguage !== i18nLanguage) {
                i18nInstance.changeLanguage(savedLanguage);
            }
        }

        // ÁõëÂê¨ i18next ËØ≠Ë®ÄÂèòÂåñ‰∫ã‰ª∂
        i18nInstance.on("languageChanged", this.handleLanguageChanged);
    }

    /**
     * ÁªÑ‰ª∂Êñ≠ÂºÄËøûÊé•Êó∂Ê∏ÖÁêÜ
     */
    protected onDisconnected(): void {
        i18nInstance.off("languageChanged", this.handleLanguageChanged);
        document.removeEventListener("click", this.handleOutsideClick, true);
    }

    /**
     * Â§ÑÁêÜ i18next ËØ≠Ë®ÄÂèòÂåñ‰∫ã‰ª∂
     */
    private handleLanguageChanged = (lng: string): void => {
        const baseLanguage = lng.split("-")[0];
        if (baseLanguage !== this.currentLanguage) {
            this.currentLanguage = baseLanguage;
            this.rerender();
        }
    };
}
