/** @jsxImportSource @wsxjs/wsx-core */
/**
 * LanguageSwitcher Component
 * ËØ≠Ë®ÄÂàáÊç¢Âô®ÁªÑ‰ª∂ÔºåÁî®‰∫éÂàáÊç¢ i18next ÁöÑËØ≠Ë®Ä
 * ‰∏ç‰ΩøÁî®ÂõΩÊóóÂõæÊ†áÔºå‰ΩøÁî®ËØ≠Ë®ÄÂêçÁß∞ÊòæÁ§∫
 *
 * ËøôÊòØ‰∏Ä‰∏™Á§∫‰æãÁªÑ‰ª∂ÔºåÂ±ïÁ§∫Â¶Ç‰ΩïÂú® WSXJS ‰∏≠‰ΩøÁî® i18next
 * ÂèÇËÄÉ RFC-0029: i18next ÂõΩÈôÖÂåñÊîØÊåÅ
 */
import { WebComponent, autoRegister, state } from "@wsxjs/wsx-core";
import { i18nInstance } from "@wsxjs/wsx-i18next";

/**
 * ËØ≠Ë®ÄÈÄâÈ°πÊé•Âè£
 */
export interface LanguageOption {
    /** ËØ≠Ë®Ä‰ª£Á†ÅÔºàÂ¶Ç 'en', 'zh'Ôºâ */
    code: string;
    /** ËØ≠Ë®ÄÊòæÁ§∫ÂêçÁß∞ÔºàÂ¶Ç 'English', '‰∏≠Êñá'Ôºâ */
    name: string;
}

@autoRegister({ tagName: "language-switcher" })
export default class LanguageSwitcher extends WebComponent {
    /** ÊîØÊåÅÁöÑËØ≠Ë®ÄÂàóË°® */
    private languages: LanguageOption[] = [
        { code: "en", name: "English" },
        { code: "zh", name: "‰∏≠Êñá" },
        { code: "es", name: "Espa√±ol" },
        { code: "fr", name: "Fran√ßais" },
        { code: "de", name: "Deutsch" },
        { code: "ja", name: "Êó•Êú¨Ë™û" },
        { code: "ko", name: "ÌïúÍµ≠Ïñ¥" },
    ];

    /** ÂΩìÂâçÈÄâ‰∏≠ÁöÑËØ≠Ë®Ä‰ª£Á†Å */
    @state private currentLanguage: string = "en";

    /** ‰∏ãÊãâËèúÂçïÊòØÂê¶ÊâìÂºÄ */
    @state private isOpen: boolean = false;

    /** ‰∏ãÊãâËèúÂçïÂÖÉÁ¥†ÂºïÁî® */
    private dropdownElement?: HTMLElement;
    private buttonElement?: HTMLElement;

    /**
     * ÂàáÊç¢‰∏ãÊãâËèúÂçï
     */
    private handleToggleDropdown(): void {
        // DEBUG: ËøΩË∏™‰∏ãÊãâËèúÂçïÂàáÊç¢
        console.log("[handleToggleDropdown] BEFORE:", {
            isOpen: this.isOpen,
        });
        this.isOpen = !this.isOpen;
        console.log("[handleToggleDropdown] AFTER:", {
            isOpen: this.isOpen,
        });
    }

    /**
     * Â§ÑÁêÜÁÇπÂáªÂ§ñÈÉ®Âå∫Âüü
     */
    private handleOutsideClick(_event: Event): void {
        // DEBUG: ËøΩË∏™Â§ñÈÉ®ÁÇπÂáª
        console.log("[handleOutsideClick] BEFORE:", {
            isOpen: this.isOpen,
        });
        this.isOpen = false;
        console.log("[handleOutsideClick] AFTER:", {
            isOpen: this.isOpen,
        });
    }

    /**
     * ÈÄâÊã©ËØ≠Ë®Ä
     */
    private handleSelectLanguage(languageCode: string): void {
        // DEBUG: ËøΩË∏™ËØ≠Ë®ÄÈÄâÊã©
        console.log("[handleSelectLanguage] BEFORE:", {
            languageCode,
            currentLanguage: this.currentLanguage,
            isOpen: this.isOpen,
        });

        if (languageCode === this.currentLanguage) {
            this.isOpen = false;
            return;
        }

        // Á´ãÂç≥Êõ¥Êñ∞Áä∂ÊÄÅÔºàÂêåÊ≠•ÔºâÔºåÁ°Æ‰øù UI Á´ãÂç≥ÂìçÂ∫î
        this.currentLanguage = languageCode;
        this.isOpen = false;

        // DEBUG: ËøΩË∏™Áä∂ÊÄÅÂèòÂåñ
        console.log("[handleSelectLanguage] AFTER:", {
            currentLanguage: this.currentLanguage,
            isOpen: this.isOpen,
        });

        requestAnimationFrame(() => {
            i18nInstance.changeLanguage(languageCode);
        });
    }

    /**
     * ÁªÑ‰ª∂ËøûÊé•Êó∂ÂàùÂßãÂåñ
     */
    protected onConnected(): void {
        super.onConnected?.();

        this.currentLanguage = i18nInstance.language;
        // ÁõëÂê¨ i18next ËØ≠Ë®ÄÂèòÂåñ‰∫ã‰ª∂
        i18nInstance.off("languageChanged", this.handleLanguageChanged);
        i18nInstance.on("languageChanged", this.handleLanguageChanged);
        document.removeEventListener("click", this.handleOutsideClick, true);
        document.addEventListener("click", this.handleOutsideClick, true);
    }

    /**
     * ÁªÑ‰ª∂Êñ≠ÂºÄËøûÊé•Êó∂Ê∏ÖÁêÜ
     */
    protected onDisconnected(): void {
        super.onDisconnected?.();
        i18nInstance.off("languageChanged", this.handleLanguageChanged);
        document.removeEventListener("click", this.handleOutsideClick, true);
    }

    /**
     * Â§ÑÁêÜ i18next ËØ≠Ë®ÄÂèòÂåñ‰∫ã‰ª∂
     */
    private handleLanguageChanged = (lng: string): void => {
        const baseLanguage = lng.split("-")[0];
        // ÂßãÁªàÊõ¥Êñ∞ currentLanguageÔºåÂç≥‰ΩøÂÄºÁõ∏Âêå‰πüË¶ÅÊõ¥Êñ∞ÔºàÁ°Æ‰øùÁä∂ÊÄÅÂêåÊ≠•Ôºâ
        // ËøôËß£ÂÜ≥‰∫ÜÂΩìÊú¨Âú∞ÂåñÊîπÂèòÊó∂ÔºåËØ≠Ë®ÄÂàáÊç¢Âô®Ê≤°ÊúâÊõ¥Êñ∞ÁöÑÈóÆÈ¢ò
        if (this.currentLanguage !== baseLanguage) {
            this.currentLanguage = baseLanguage;
        }
    };

    render(): HTMLElement {
        // DEBUG: ËøΩË∏™Ê∏≤Êüì
        console.log("[LanguageSwitcher.render] DEBUG:", {
            currentLanguage: this.currentLanguage,
            isOpen: this.isOpen,
        });

        // ‰ΩøÁî®ÂìçÂ∫îÂºèÁöÑ this.currentLanguageÔºåËÄå‰∏çÊòØ i18nInstance.language
        const currentLang = this.languages.find((lang) => lang.code === this.currentLanguage);
        const displayName = currentLang?.name || this.currentLanguage.toUpperCase();

        return (
            <div class="language-switcher-container">
                <button
                    ref={(el) => (this.buttonElement = el)}
                    class="language-switcher-btn"
                    onClick={() => this.handleToggleDropdown()}
                    aria-label={`Current language: ${displayName}`}
                    aria-expanded={this.isOpen}
                    aria-haspopup="listbox"
                >
                    <span class="language-switcher-icon">üåê</span>
                    <span class="language-switcher-text">{displayName}</span>
                    <span class="language-switcher-arrow">{this.isOpen ? "‚ñ≤" : "‚ñº"}</span>
                </button>

                {this.isOpen && (
                    <div
                        ref={(el) => (this.dropdownElement = el)}
                        class="language-switcher-dropdown"
                        role="listbox"
                    >
                        {this.languages.map((lang) => (
                            <button
                                key={lang.code}
                                class={`language-switcher-option ${
                                    lang.code === this.currentLanguage ? "active" : ""
                                }`}
                                onClick={() => this.handleSelectLanguage(lang.code)}
                                role="option"
                                aria-selected={lang.code === this.currentLanguage}
                            >
                                <span class="language-name">{lang.name}</span>
                                <span class="language-code">{lang.code.toUpperCase()}</span>
                            </button>
                        ))}
                    </div>
                )}
            </div>
        );
    }
}
