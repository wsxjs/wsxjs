/** @jsxImportSource @wsxjs/wsx-core */
import { WebComponent, autoRegister, state } from "@wsxjs/wsx-core";
import { i18n } from "@wsxjs/wsx-i18next";
import { RouterUtils } from "@wsxjs/wsx-router";
import styles from "./UseCaseSection.css?inline";
import "@wsxjs/wsx-base-components";

@autoRegister({ tagName: "use-case-section" })
@i18n("usecase")
export default class UseCaseSection extends WebComponent {
    @state private activeCase: string = "";

    constructor() {
        super({
            styles,
            styleName: "use-case-section",
        });
    }

    protected onConnected() {
        super.onConnected?.();
        this.setupScrollObserver();
    }

    protected onDisconnected() {
        super.onDisconnected?.();
        // Cleanup will be handled by WebComponent base class
    }

    private setupScrollObserver = () => {
        // Use setTimeout to ensure DOM is fully rendered
        setTimeout(() => {
            if (!this.shadowRoot) {
                console.warn("Shadow root not available for scroll observer");
                return;
            }

            const observer = new IntersectionObserver(
                (entries) => {
                    entries.forEach((entry) => {
                        if (entry.isIntersecting && entry.intersectionRatio > 0.3) {
                            this.activeCase = entry.target.id;
                            this.updateNavActiveState();
                        }
                    });
                },
                {
                    rootMargin: "-20% 0px -60% 0px",
                    threshold: [0, 0.3, 0.6, 1],
                }
            );

            const cases = ["editorjs", "marked", "slidejs", "calendarjs"];
            cases.forEach((id) => {
                // Find element in shadow root (WebComponent uses Shadow DOM)
                const element = this.shadowRoot?.getElementById(id);

                if (element) {
                    observer.observe(element);
                } else {
                    console.warn(
                        `Could not find element with id "${id}" in shadow root for scroll observer`
                    );
                }
            });
        }, 200);
    };

    private updateNavActiveState = () => {
        // Try to find nav items in shadow root or light DOM
        let navItems: NodeListOf<Element>;

        if (this.shadowRoot) {
            navItems = this.shadowRoot.querySelectorAll(".nav-item");
        } else {
            navItems = this.querySelectorAll(".nav-item");
        }

        navItems.forEach((item) => {
            const button = item as HTMLButtonElement;
            const caseId = button.dataset.caseId;
            if (caseId === this.activeCase) {
                button.classList.add("active");
            } else {
                button.classList.remove("active");
            }
        });
    };

    private handleCardClick = (path: string) => {
        RouterUtils.navigate(path);
    };

    private scrollToCase = (id: string, event?: Event) => {
        // Prevent default and stop propagation
        if (event) {
            event.preventDefault();
            event.stopPropagation();
        }

        // Find element in shadow root (WebComponent uses Shadow DOM)
        const element = this.shadowRoot?.getElementById(id);

        if (!element) {
            console.warn(`[UseCaseSection] Element with id "${id}" not found in shadow root`);
            console.debug(
                `[UseCaseSection] Available elements:`,
                Array.from(this.shadowRoot?.querySelectorAll("[id]") || []).map((el) => el.id)
            );
            return;
        }

        // Get the component's position in the document
        const componentRect = this.getBoundingClientRect();
        const componentTop = componentRect.top + window.pageYOffset;

        // Get element position relative to the component
        const elementRect = element.getBoundingClientRect();
        const elementTopRelative = elementRect.top - componentRect.top;

        // Calculate absolute position in document
        const elementPosition = componentTop + elementTopRelative;

        // Calculate offset for sticky nav
        const navHeight = 70; // Main navigation bar height
        const stickyNavHeight = 60; // Sticky nav approximate height
        const offset = navHeight + stickyNavHeight + 20; // Extra padding

        const offsetPosition = elementPosition - offset;

        // Smooth scroll to element
        window.scrollTo({
            top: Math.max(0, offsetPosition),
            behavior: "smooth",
        });
    };

    render() {
        // eslint-disable-next-line @typescript-eslint/no-explicit-any
        const t = ((this as any).t as (key: string, options?: object) => string).bind(this);

        const cases = [
            { id: "editorjs", key: "editorjs" },
            { id: "marked", key: "marked" },
            { id: "slidejs", key: "slidejs" },
            { id: "calendarjs", key: "calendarjs" },
        ];

        return (
            <section id="use-cases" class="use-case-section">
                <div class="container">
                    <div class="section-header">
                        <h2 class="section-title">{t("title")}</h2>
                        <p class="section-description">{t("description")}</p>
                    </div>

                    {/* Sticky Navigation */}
                    <nav class="use-cases-nav">
                        {cases.map((caseItem) => (
                            <button
                                key={caseItem.id}
                                type="button"
                                class={`nav-item ${this.activeCase === caseItem.id ? "active" : ""}`}
                                data-case-id={caseItem.id}
                                onClick={(e) => this.scrollToCase(caseItem.id, e)}
                            >
                                {t(`cases.${caseItem.key}.title`)}
                            </button>
                        ))}
                    </nav>

                    <div class="use-cases-grid">
                        {/* EditorJS Use Case */}
                        <div
                            id="editorjs"
                            class="use-case-card"
                            onClick={() => this.handleCardClick("/editorjs")}
                        >
                            <div class="use-case-content">
                                <h3 class="use-case-title">
                                    <span class="use-case-icon">ğŸ“</span>
                                    {t("cases.editorjs.title")}
                                    <span class="use-case-badge">{t("cases.editorjs.badge")}</span>
                                </h3>
                                <p class="use-case-description">
                                    {t("cases.editorjs.description")}
                                </p>

                                <div class="use-case-why">
                                    <h4 class="why-title">{t("cases.editorjs.why.title")}</h4>
                                    <ul class="why-list">
                                        <li>{t("cases.editorjs.why.reason1")}</li>
                                        <li>{t("cases.editorjs.why.reason2")}</li>
                                        <li>{t("cases.editorjs.why.reason3")}</li>
                                        <li>{t("cases.editorjs.why.reason4")}</li>
                                    </ul>
                                </div>

                                <div class="use-case-features">
                                    <h4 class="features-title">
                                        {t("cases.editorjs.features.title")}
                                    </h4>
                                    <ul class="features-list">
                                        <li>{t("cases.editorjs.features.feature1")}</li>
                                        <li>{t("cases.editorjs.features.feature2")}</li>
                                        <li>{t("cases.editorjs.features.feature3")}</li>
                                    </ul>
                                </div>

                                <div class="use-case-action">
                                    <span class="use-case-link">
                                        {t("cases.editorjs.action")} â†’
                                    </span>
                                </div>
                            </div>
                        </div>

                        {/* Marked Use Case */}
                        <div
                            id="marked"
                            class="use-case-card"
                            onClick={() => this.handleCardClick("/marked")}
                        >
                            <div class="use-case-content">
                                <h3 class="use-case-title">
                                    <span class="use-case-icon">ğŸ“„</span>
                                    {t("cases.marked.title")}
                                    <span class="use-case-badge">{t("cases.marked.badge")}</span>
                                </h3>
                                <p class="use-case-description">{t("cases.marked.description")}</p>

                                <div class="use-case-why">
                                    <h4 class="why-title">{t("cases.marked.why.title")}</h4>
                                    <ul class="why-list">
                                        <li>{t("cases.marked.why.reason1")}</li>
                                        <li>{t("cases.marked.why.reason2")}</li>
                                        <li>{t("cases.marked.why.reason3")}</li>
                                        <li>{t("cases.marked.why.reason4")}</li>
                                    </ul>
                                </div>

                                <div class="use-case-features">
                                    <h4 class="features-title">
                                        {t("cases.marked.features.title")}
                                    </h4>
                                    <ul class="features-list">
                                        <li>{t("cases.marked.features.feature1")}</li>
                                        <li>{t("cases.marked.features.feature2")}</li>
                                        <li>{t("cases.marked.features.feature3")}</li>
                                    </ul>
                                </div>

                                <div class="use-case-action">
                                    <span class="use-case-link">{t("cases.marked.action")} â†’</span>
                                </div>
                            </div>
                        </div>

                        {/* SlideJS Use Case */}
                        <div
                            id="slidejs"
                            class="use-case-card"
                            onClick={() => this.handleCardClick("/slidejs")}
                        >
                            <div class="use-case-content">
                                <h3 class="use-case-title">
                                    <span class="use-case-icon">ğŸ“Š</span>
                                    {t("cases.slidejs.title")}
                                    <span class="use-case-badge">{t("cases.slidejs.badge")}</span>
                                </h3>
                                <p class="use-case-description">{t("cases.slidejs.description")}</p>

                                <div class="use-case-why">
                                    <h4 class="why-title">{t("cases.slidejs.why.title")}</h4>
                                    <ul class="why-list">
                                        <li>{t("cases.slidejs.why.reason1")}</li>
                                        <li>{t("cases.slidejs.why.reason2")}</li>
                                        <li>{t("cases.slidejs.why.reason3")}</li>
                                        <li>{t("cases.slidejs.why.reason4")}</li>
                                    </ul>
                                </div>

                                <div class="use-case-features">
                                    <h4 class="features-title">
                                        {t("cases.slidejs.features.title")}
                                    </h4>
                                    <ul class="features-list">
                                        <li>{t("cases.slidejs.features.feature1")}</li>
                                        <li>{t("cases.slidejs.features.feature2")}</li>
                                        <li>{t("cases.slidejs.features.feature3")}</li>
                                    </ul>
                                </div>

                                <div class="use-case-action">
                                    <span class="use-case-link">{t("cases.slidejs.action")} â†’</span>
                                </div>
                            </div>
                        </div>

                        {/* CalendarJS Use Case */}
                        <div
                            id="calendarjs"
                            class="use-case-card"
                            onClick={() => this.handleCardClick("/calendarjs")}
                        >
                            <div class="use-case-content">
                                <h3 class="use-case-title">
                                    <span class="use-case-icon">ğŸ“…</span>
                                    {t("cases.calendarjs.title")}
                                    <span class="use-case-badge">
                                        {t("cases.calendarjs.badge")}
                                    </span>
                                </h3>
                                <p class="use-case-description">
                                    {t("cases.calendarjs.description")}
                                </p>

                                <div class="use-case-why">
                                    <h4 class="why-title">{t("cases.calendarjs.why.title")}</h4>
                                    <ul class="why-list">
                                        <li>{t("cases.calendarjs.why.reason1")}</li>
                                        <li>{t("cases.calendarjs.why.reason2")}</li>
                                        <li>{t("cases.calendarjs.why.reason3")}</li>
                                        <li>{t("cases.calendarjs.why.reason4")}</li>
                                    </ul>
                                </div>

                                <div class="use-case-features">
                                    <h4 class="features-title">
                                        {t("cases.calendarjs.features.title")}
                                    </h4>
                                    <ul class="features-list">
                                        <li>{t("cases.calendarjs.features.feature1")}</li>
                                        <li>{t("cases.calendarjs.features.feature2")}</li>
                                        <li>{t("cases.calendarjs.features.feature3")}</li>
                                    </ul>
                                </div>

                                <div class="use-case-action">
                                    <span class="use-case-link">
                                        {t("cases.calendarjs.action")} â†’
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        );
    }
}
