# Postinstall Script

## 功能说明

`postinstall.mjs` 脚本会在用户安装 `@wsxjs/wsx-core` 后自动运行，自动生成 `wsx.d.ts` 类型声明文件。

## 工作原理

1. **检测项目结构**：
   - 优先查找 `src/types/` 目录
   - 其次查找 `types/` 目录
   - 再次查找 `src/` 目录
   - 最后使用项目根目录

2. **生成 `wsx.d.ts`**：
   - 在检测到的位置创建类型声明文件
   - 如果文件已存在且是自动生成的，则更新它
   - 如果文件已存在且是用户自定义的，则跳过（不覆盖）

3. **更新 `tsconfig.json`**：
   - 自动将 `wsx.d.ts` 添加到 `include` 数组中
   - 如果 `tsconfig.json` 不存在或无效，则跳过

## 文件位置优先级

脚本会按以下优先级选择 `wsx.d.ts` 的位置：

1. **`src/types/wsx.d.ts`** - 最推荐（如果存在 `src/` 目录）
2. **`types/wsx.d.ts`** - 次推荐（如果存在 `types/` 目录）
3. **`src/wsx.d.ts`** - 备选（如果存在 `src/` 但无 `types/` 子目录）
4. **`wsx.d.ts`** - 最后备选（项目根目录）

## 生成的文件内容

```typescript
// Type declaration for .wsx files
// This file is automatically generated by @wsxjs/wsx-core
// You can safely delete it if you don't use .wsx files, or customize it as needed.

declare module "*.wsx" {
    import { WebComponent, LightComponent } from "@wsxjs/wsx-core";
    // Allow any class that extends WebComponent or LightComponent
    const Component: new (...args: unknown[]) => WebComponent | LightComponent;
    export default Component;
}
```

## 追踪生成的文件

生成的文件包含以下信息，便于追踪：

1. **文件头部注释**：包含生成时间和说明
2. **控制台输出**：安装时会显示文件位置和完整路径
3. **文件内容标记**：包含 `@wsxjs/wsx-core` 标识，用于识别自动生成的文件

### 查看生成的文件位置

安装后，控制台会显示：
```
[@wsxjs/wsx-core] ✅ Created wsx.d.ts at: src/types/wsx.d.ts
   Full path: /path/to/your/project/src/types/wsx.d.ts
   This file enables TypeScript support for .wsx files.
```

### 识别自动生成的文件

自动生成的文件包含以下特征：
- 文件头部有 `// This file is automatically generated by @wsxjs/wsx-core`
- 包含生成时间戳：`// Generated at: 2025-01-15T10:30:00.000Z`
- 包含 `@wsxjs/wsx-core` 导入语句

## 禁用自动生成

如果不想自动生成 `wsx.d.ts`，可以在 `package.json` 中添加配置：

```json
{
  "wsx": {
    "skipAutoTypes": true
  }
}
```

## 跳过条件

脚本会在以下情况跳过执行：

1. 项目是 WSX Framework 自己的 monorepo（检测 `pnpm-workspace.yaml` 或 `packages/` 目录）
2. 项目根目录没有 `package.json`
3. `wsx.d.ts` 已存在且是用户自定义的（不包含 `@wsxjs/wsx-core` 导入）
4. 用户配置了 `"wsx": { "skipAutoTypes": true }`

## 手动运行

如果需要手动运行脚本（例如在 CI/CD 中）：

```bash
node node_modules/@wsxjs/wsx-core/scripts/postinstall.mjs
```

## 注意事项

- 脚本使用静默失败策略：如果出错，只会输出警告，不会导致安装失败
- 脚本不会覆盖用户自定义的 `wsx.d.ts` 文件
- 脚本会自动检测并跳过 monorepo 环境

