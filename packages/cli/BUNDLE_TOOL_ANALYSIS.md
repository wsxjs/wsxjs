# 打包工具对比分析：是否有比 tsup 更好的选择？

## 当前项目使用情况

### 使用 tsup 的包（4个）
1. `@wsxjs/wsx-core` - 核心框架
2. `@wsxjs/wsx-vite-plugin` - Vite 插件
3. `@wsxjs/eslint-plugin-wsx` - ESLint 插件
4. `@wsxjs/cli` - CLI 工具

### 使用 Vite 的包（3个）
1. `@wsxjs/wsx-base-components` - 组件库（需要 CSS 内联）
2. `@wsxjs/wsx-router` - 路由库（需要 CSS 内联）
3. `@wsxjs/wsx-examples` - 示例应用

## 打包工具对比

### 1. tsup（当前使用）

**优势：**
- ✅ **极快**：基于 esbuild，构建速度极快（~20-30ms）
- ✅ **零配置**：开箱即用，无需配置文件
- ✅ **TypeScript 原生支持**：自动处理 TS，生成 `.d.ts`
- ✅ **多格式支持**：同时输出 CJS 和 ESM
- ✅ **轻量级**：依赖少，安装快
- ✅ **活跃维护**：由 egoist 维护，社区活跃

**劣势：**
- ❌ **CSS 支持有限**：无法内联 CSS 到 JS（RFC-0016 问题）
- ❌ **插件生态较小**：相比 Rollup/Vite 插件少
- ❌ **复杂场景支持有限**：不适合需要复杂构建逻辑的项目

**适用场景：**
- ✅ TypeScript 库/工具
- ✅ CLI 工具
- ✅ 不需要 CSS 的包
- ✅ 需要快速构建的项目

### 2. unbuild（Nuxt 团队开发）

**优势：**
- ✅ **基于 rollup**：更强大的功能
- ✅ **零配置**：类似 tsup，但功能更丰富
- ✅ **更好的类型支持**：自动生成类型定义
- ✅ **支持 CSS**：可以处理 CSS（但不如 Vite 灵活）
- ✅ **现代设计**：专为现代库开发设计
- ✅ **活跃维护**：Nuxt 团队维护

**劣势：**
- ⚠️ **相对较新**：社区生态不如 tsup 成熟
- ⚠️ **文档较少**：相比 tsup 文档不够丰富
- ⚠️ **构建速度**：比 tsup 慢（基于 Rollup）

**适用场景：**
- ✅ 需要比 tsup 更多功能的库
- ✅ 需要 CSS 支持但不想用 Vite
- ✅ Nuxt 生态系统项目

### 3. Rollup

**优势：**
- ✅ **成熟稳定**：最成熟的打包工具之一
- ✅ **强大功能**：支持复杂的构建场景
- ✅ **优秀插件生态**：丰富的插件系统
- ✅ **Tree-shaking**：最好的 tree-shaking 支持
- ✅ **CSS 支持**：通过插件支持 CSS

**劣势：**
- ❌ **配置复杂**：需要大量配置
- ❌ **构建速度慢**：比 esbuild 慢很多
- ❌ **TypeScript 支持**：需要额外配置
- ❌ **学习曲线**：配置复杂，学习成本高

**适用场景：**
- ✅ 需要复杂构建逻辑的项目
- ✅ 需要最佳 tree-shaking 的库
- ✅ 大型项目

### 4. esbuild（tsup 的底层）

**优势：**
- ✅ **极快**：最快的打包工具
- ✅ **零运行时依赖**：Go 编写，性能极佳
- ✅ **TypeScript 支持**：原生支持

**劣势：**
- ❌ **需要手动配置**：没有 tsup 的零配置体验
- ❌ **CSS 支持有限**：不支持 CSS 内联
- ❌ **插件生态小**：插件较少
- ❌ **配置复杂**：需要更多配置代码

**适用场景：**
- ✅ 需要极致性能的项目
- ✅ 愿意手动配置的项目

### 5. Vite（已在使用）

**优势：**
- ✅ **CSS 支持完善**：完美支持 CSS 内联（`cssCodeSplit: false`）
- ✅ **开发体验好**：HMR、快速启动
- ✅ **成熟稳定**：广泛使用，社区大
- ✅ **插件生态丰富**：大量插件可用

**劣势：**
- ❌ **构建速度**：比 tsup 慢（基于 Rollup）
- ❌ **配置复杂**：需要配置文件
- ❌ **体积大**：依赖较多

**适用场景：**
- ✅ 需要 CSS 内联的组件库（RFC-0016）
- ✅ 应用开发
- ✅ 需要开发服务器的项目

## 推荐方案

### 方案 A：保持现状（推荐）✅

**继续使用 tsup 用于库/工具，Vite 用于组件库**

**理由：**
1. ✅ **当前方案已经最优**：
   - tsup 对于纯 TypeScript 库是最佳选择
   - Vite 对于需要 CSS 的组件库是必需选择
   - 分工明确，各司其职

2. ✅ **性能最优**：
   - tsup 构建速度最快（~20-30ms）
   - 只在需要 CSS 的地方使用 Vite

3. ✅ **维护成本低**：
   - 不需要迁移现有代码
   - 团队已经熟悉工具链

4. ✅ **符合项目需求**：
   - CLI/插件/库：不需要 CSS → tsup
   - 组件库：需要 CSS 内联 → Vite

### 方案 B：统一使用 unbuild

**将所有 tsup 包迁移到 unbuild**

**优势：**
- ✅ 统一工具链
- ✅ 更好的 CSS 支持（虽然仍不如 Vite）
- ✅ 更现代的设计

**劣势：**
- ❌ **迁移成本高**：需要重写所有构建配置
- ❌ **性能下降**：比 tsup 慢（基于 Rollup）
- ❌ **社区生态较小**：不如 tsup 成熟
- ❌ **仍然无法解决 CSS 内联问题**：组件库仍需 Vite

**结论：** ❌ 不推荐，迁移成本高，收益不明显

### 方案 C：统一使用 Rollup

**将所有包迁移到 Rollup**

**优势：**
- ✅ 最成熟的工具
- ✅ 强大的功能
- ✅ 优秀的插件生态

**劣势：**
- ❌ **配置复杂**：需要大量配置代码
- ❌ **构建速度慢**：比 tsup 慢很多
- ❌ **迁移成本极高**：需要重写所有配置
- ❌ **过度设计**：对于简单库来说太复杂

**结论：** ❌ 不推荐，过度设计，性能下降

## 详细对比表

| 工具 | 速度 | 配置 | CSS 支持 | TypeScript | 生态 | 维护 | 推荐度 |
|------|------|------|----------|------------|------|------|--------|
| **tsup** | ⚡⚡⚡ | ✅ 零配置 | ❌ 有限 | ✅ 原生 | ⭐⭐⭐ | ✅ 活跃 | ⭐⭐⭐⭐⭐ |
| **unbuild** | ⚡⚡ | ✅ 零配置 | ⚠️ 部分 | ✅ 原生 | ⭐⭐ | ✅ 活跃 | ⭐⭐⭐⭐ |
| **Rollup** | ⚡ | ❌ 复杂 | ✅ 完整 | ⚠️ 需配置 | ⭐⭐⭐⭐⭐ | ✅ 活跃 | ⭐⭐⭐ |
| **esbuild** | ⚡⚡⚡ | ❌ 需配置 | ❌ 有限 | ✅ 原生 | ⭐⭐ | ✅ 活跃 | ⭐⭐⭐ |
| **Vite** | ⚡⚡ | ⚠️ 需配置 | ✅ 完整 | ✅ 原生 | ⭐⭐⭐⭐⭐ | ✅ 活跃 | ⭐⭐⭐⭐⭐ |

## 针对 CLI 包的建议

### 当前 CLI 包使用 tsup

```json
"build": "tsup src/index.ts --format esm --dts --clean"
```

### 是否应该更换？

**结论：不需要更换** ✅

**理由：**
1. ✅ **CLI 不需要 CSS**：纯 Node.js 工具
2. ✅ **构建速度极快**：tsup 是最快的选择
3. ✅ **零配置**：当前配置已经完美
4. ✅ **无痛点**：没有遇到任何问题

### 如果一定要更换，unbuild 是唯一候选

**unbuild 配置示例：**

```typescript
// build.config.ts
import { defineBuildConfig } from 'unbuild'

export default defineBuildConfig({
  entries: ['src/index'],
  clean: true,
  declaration: true,
  rollup: {
    emitCJS: false, // 只输出 ESM
  },
})
```

**但迁移收益：**
- ⚠️ 构建速度可能变慢
- ⚠️ 需要学习新工具
- ⚠️ 迁移成本
- ✅ 功能略多（但 CLI 不需要）

**结论：** 不值得迁移

## 最终建议

### ✅ 保持现状（最佳选择）

**继续使用：**
- **tsup**：用于所有纯 TypeScript 库/工具（core, vite-plugin, eslint-plugin, cli）
- **Vite**：用于需要 CSS 内联的组件库（base-components, router）

**理由：**
1. ✅ **性能最优**：tsup 构建最快
2. ✅ **配置最简单**：零配置体验
3. ✅ **分工明确**：各工具用于最适合的场景
4. ✅ **无痛点**：当前方案完美满足需求
5. ✅ **维护成本低**：不需要迁移

### 未来考虑

如果未来遇到以下情况，可以考虑 unbuild：
- 需要比 tsup 更多的功能
- 需要更好的 CSS 支持（但仍不如 Vite）
- 愿意接受稍慢的构建速度

但**目前没有理由更换**。

## 参考资源

- [tsup 文档](https://tsup.egoist.dev/)
- [unbuild 文档](https://github.com/unjs/unbuild)
- [Rollup 文档](https://rollupjs.org/)
- [esbuild 文档](https://esbuild.github.io/)
- [Vite 文档](https://vitejs.dev/)

## 总结

**对于 CLI 包和纯 TypeScript 库，tsup 仍然是最佳选择。** 

没有更好的替代方案，因为：
1. ✅ 构建速度最快
2. ✅ 配置最简单
3. ✅ 完美满足需求
4. ✅ 社区活跃，维护良好

**建议：保持现状，继续使用 tsup。** 🎯

