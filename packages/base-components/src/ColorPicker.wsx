/** @jsxImportSource @wsxjs/wsx-core */
/**
 * é€šç”¨WSXé¢œè‰²é€‰æ‹©å™¨ - Web Componentç¤ºä¾‹
 *
 * ä½¿ç”¨ .wsx æ‰©å±•åäº«å—çœŸæ­£çš„TSXè¯­æ³•ï¼š
 * - ç»§æ‰¿EditorJSToolComponent
 * - çœŸæ­£çš„JSXè¯­æ³•æ”¯æŒ
 * - æ”¯æŒå¤–éƒ¨CSSæ–‡ä»¶
 * - å®Œå…¨é€šç”¨ï¼Œä¸ä¾èµ–ç‰¹å®šUIåº“
 */

import { WebComponent, autoRegister } from "@wsxjs/wsx-core";
import { createLogger } from "@wsxjs/wsx-logger";
import {
    handleCSSVariables,
    setDefaultColorCache,
    getCustomColorCache,
    setCustomColorCache,
    throttle,
} from "./ColorPickerUtils";
import type { PluginType } from "./ColorPickerUtils";

const logger = createLogger("ColorPicker");

// å¯¼å‡ºColorPickerUtilsæ–¹æ³• ç”¨äºå¤–éƒ¨è°ƒç”¨
export * from "./ColorPickerUtils";

/**
 * é¢œè‰²é€‰æ‹©å™¨é…ç½®æ¥å£
 */
export interface ColorPickerConfig {
    colorCollections?: string[];
    onColorPicked?: (color: string) => void;
    hasCustomPicker?: boolean;
    defaultColor?: string;
    pluginType?: PluginType;
    disabled?: boolean;
    api?: unknown; // EditorJS API
}

/**
 * é»˜è®¤é¢œè‰²é›†åˆ
 */
const DEFAULT_COLORS = [
    "#ff1300",
    "#EC7878",
    "#9C27B0",
    "#673AB7",
    "#3F51B5",
    "#0070FF",
    "#03A9F4",
    "#00BCD4",
    "#4CAF50",
    "#8BC34A",
    "#CDDC39",
    "#FFE500",
    "#FFBF00",
    "#FF9800",
    "#795548",
    "#9E9E9E",
    "#5A5A5A",
    "#FFF",
];

/**
 *  é¢œè‰²é€‰æ‹©å™¨ç»„ä»¶ Web Component with JSX aka WSX
 */
@autoRegister({ tagName: "wsx-color-picker" })
export default class ColorPicker extends WebComponent {
    private colorCollections: string[];
    private onColorPicked?: (color: string) => void;
    private hasCustomPicker: boolean;
    private defaultColor: string;
    private pluginType: PluginType;
    private disabled: boolean;

    // çŠ¶æ€
    private selectedColor: string;
    private customColor: string;
    private isOpen: boolean;

    // DOMå¼•ç”¨
    private colorBtn?: HTMLElement;
    private colorPanel?: HTMLElement;

    static get observedAttributes(): string[] {
        return ["disabled", "selected-color", "open"];
    }

    constructor(config: ColorPickerConfig = {}) {
        super({
            styleName: "base-color-picker",
            ...config,
        });

        // åˆå§‹åŒ–é…ç½®
        this.colorCollections = config.colorCollections || DEFAULT_COLORS;
        this.onColorPicked = config.onColorPicked;
        this.hasCustomPicker = config.hasCustomPicker || false;
        this.pluginType = config.pluginType || "text";
        this.disabled = config.disabled || false;

        // åˆå§‹åŒ–çŠ¶æ€
        this.defaultColor = handleCSSVariables(config.defaultColor || this.colorCollections[0]);
        this.selectedColor = this.defaultColor;
        this.customColor = getCustomColorCache(this.pluginType) || "";
        this.isOpen = false;

        logger.debug("ColorPicker initialized", {
            colorCollections: this.colorCollections.length,
            hasCustomPicker: this.hasCustomPicker,
            pluginType: this.pluginType,
        });
    }

    /**
     * å®ç°æŠ½è±¡æ–¹æ³•ï¼šçœŸæ­£çš„JSXæ¸²æŸ“ï¼ğŸ‰
     */
    render(): HTMLElement {
        const colorButton = this.renderColorButton();
        const colorPanel = this.isOpen ? this.renderColorPanel() : null;

        return (
            <section class="color-section">
                <div class="color-popover">
                    {colorButton}
                    {colorPanel}
                </div>
            </section>
        );
    }

    /**
     * æ¸²æŸ“é¢œè‰²æŒ‰é’® - çœŸæ­£çš„JSXï¼
     */
    private renderColorButton(): HTMLElement {
        return (
            <wsx-button
                type="button"
                class={`color-btn ${this.disabled ? "disabled" : ""}`}
                style={`--theme-color: ${this.selectedColor}`}
                disabled={this.disabled}
                onClick={this.handleButtonClick}
                ref={(el: HTMLButtonElement) => {
                    this.colorBtn = el;
                }}
            >
                <span class="color-indicator">_</span>
            </wsx-button>
        );
    }

    /**
     * æ¸²æŸ“é¢œè‰²é¢æ¿ - çœŸæ­£çš„JSXï¼
     */
    private renderColorPanel(): HTMLElement {
        return (
            <div
                class="color-panel"
                onClick={this.handlePanelClick}
                ref={(el: HTMLDivElement) => {
                    this.colorPanel = el;
                }}
            >
                <div class="color-grid">
                    {this.hasCustomPicker ? this.renderCustomPicker() : null}
                    {this.renderColorButtons()}
                </div>
            </div>
        );
    }

    /**
     * æ¸²æŸ“è‡ªå®šä¹‰é¢œè‰²é€‰æ‹©å™¨ - çœŸæ­£çš„JSXï¼
     */
    private renderCustomPicker(): HTMLElement {
        return (
            <wsx-button
                type="button"
                class="color-cube custom-picker"
                style={{ backgroundColor: this.customColor }}
                onClick={this.handleCustomPickerClick}
                title="è‡ªå®šä¹‰é¢œè‰²"
            />
        );
    }

    /**
     * æ¸²æŸ“é¢œè‰²æŒ‰é’®ç»„ - çœŸæ­£çš„JSXï¼
     */
    private renderColorButtons(): HTMLElement[] {
        return this.colorCollections.map((color) => (
            <wsx-button
                key={color}
                type="button"
                class="color-cube"
                style={`background-color: ${color}`}
                data-color={color}
                title={color}
                onClick={() => this.handleColorSelect(color)}
            />
        ));
    }

    /**
     * å¤„ç†ä¸»æŒ‰é’®ç‚¹å‡»
     */
    private handleButtonClick = (event: Event): void => {
        event.stopPropagation();
        this.togglePanel();
    };

    /**
     * å¤„ç†é¢æ¿ç‚¹å‡»
     */
    private handlePanelClick = (event: Event): void => {
        event.stopPropagation();
    };

    /**
     * å¤„ç†é¢œè‰²é€‰æ‹©
     */
    private handleColorSelect = (color: string): void => {
        const processedColor = handleCSSVariables(color);
        this.setSelectedColor(processedColor);
        this.closePanel();

        // ç¼“å­˜é€‰æ‹©çš„é¢œè‰²
        setDefaultColorCache(processedColor, this.pluginType);

        // è§¦å‘å›è°ƒå’Œäº‹ä»¶
        this.onColorPicked?.(processedColor);
        this.dispatchEvent(
            new CustomEvent("colorchange", {
                detail: { color: processedColor },
                bubbles: true,
                composed: true,
            })
        );

        logger.debug("Color selected", { color: processedColor });
    };

    /**
     * å¤„ç†è‡ªå®šä¹‰é¢œè‰²é€‰æ‹©å™¨ç‚¹å‡»
     */
    private handleCustomPickerClick = (): void => {
        const input = document.createElement("input");
        input.type = "color";
        input.value = this.customColor;
        input.style.cssText = `
            position: fixed;
            left: -9999px;
            opacity: 0;
            pointer-events: none;
        `;

        const handleInput = throttle((e: Event) => {
            const target = e.target as HTMLInputElement;
            const color = handleCSSVariables(target.value);

            this.setSelectedColor(color);
            this.setCustomColor(color);

            // æ¸…ç†è¾“å…¥å…ƒç´ 
            document.body.removeChild(input);

            // è§¦å‘å›è°ƒ
            this.onColorPicked?.(color);
            this.dispatchEvent(
                new CustomEvent("colorchange", {
                    detail: { color },
                    bubbles: true,
                    composed: true,
                })
            );

            logger.debug("Custom color selected", { color });
        }, 30);

        input.addEventListener("input", handleInput);
        document.body.appendChild(input);

        // è§¦å‘é¢œè‰²é€‰æ‹©å™¨
        requestAnimationFrame(() => {
            input.focus();
            input.click();
        });
    };

    /**
     * åˆ‡æ¢é¢æ¿æ˜¾ç¤ºçŠ¶æ€
     */
    private togglePanel(): void {
        this.setOpen(!this.isOpen);
    }

    /**
     * å…³é—­é¢æ¿
     */
    private closePanel(): void {
        this.setOpen(false);
    }

    /**
     * è®¾ç½®é€‰ä¸­çš„é¢œè‰²
     */
    private setSelectedColor(color: string): void {
        this.selectedColor = color;
        this.setAttr("selected-color", color);
        this.updateColorButton();
    }

    /**
     * è®¾ç½®è‡ªå®šä¹‰é¢œè‰²
     */
    private setCustomColor(color: string): void {
        this.customColor = color;
        setCustomColorCache(color, this.pluginType);
    }

    /**
     * è®¾ç½®é¢æ¿å¼€å…³çŠ¶æ€
     */
    private setOpen(open: boolean): void {
        this.isOpen = open;

        if (open) {
            this.setAttr("open", "");
        } else {
            this.removeAttr("open");
        }

        this.rerender();
    }

    /**
     * æ›´æ–°é¢œè‰²æŒ‰é’®æ ·å¼
     */
    private updateColorButton(): void {
        if (this.colorBtn) {
            this.colorBtn.style.setProperty("--theme-color", this.selectedColor);
        }
    }

    /**
     * ç»„ä»¶è¿æ¥åˆ°DOMåçš„åˆå§‹åŒ–
     */
    protected onConnected(): void {
        super.onConnected?.();
        // ç»‘å®šå…¨å±€ç‚¹å‡»äº‹ä»¶ä»¥å…³é—­é¢æ¿
        document.addEventListener("click", this.handleDocumentClick);

        logger.info("ColorPicker connected to DOM");
    }

    /**
     * ç»„ä»¶ä»DOMæ–­å¼€æ—¶çš„æ¸…ç†
     */
    protected onDisconnected(): void {
        super.onDisconnected?.();
        document.removeEventListener("click", this.handleDocumentClick);

        logger.info("ColorPicker disconnected from DOM");
    }

    /**
     * å±æ€§å˜åŒ–å¤„ç†
     */
    protected onAttributeChanged(name: string, _oldValue: string, newValue: string): void {
        switch (name) {
            case "disabled":
                this.disabled = newValue !== null;
                this.rerender();
                break;
            case "selected-color":
                if (newValue && newValue !== this.selectedColor) {
                    this.selectedColor = newValue;
                    this.updateColorButton();
                }
                break;
            case "open":
                this.isOpen = newValue !== null;
                break;
        }
    }

    /**
     * å¤„ç†æ–‡æ¡£ç‚¹å‡»ä»¥å…³é—­é¢æ¿
     */
    private handleDocumentClick = (event: Event): void => {
        if (this.isOpen && !this.contains(event.target as Node)) {
            this.closePanel();
        }
    };

    /**
     * å…¬å…±APIï¼šè·å–å½“å‰é€‰ä¸­çš„é¢œè‰²
     */
    public getSelectedColor(): string {
        return this.selectedColor;
    }

    /**
     * å…¬å…±APIï¼šè®¾ç½®é¢œè‰²
     */
    public setColor(color: string): void {
        this.setSelectedColor(handleCSSVariables(color));
    }

    /**
     * å…¬å…±APIï¼šèšç„¦ç»„ä»¶
     */
    public focus(): void {
        this.colorBtn?.focus();
    }
}
